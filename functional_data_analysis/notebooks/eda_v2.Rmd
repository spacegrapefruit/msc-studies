## 1. Detecting and Visualizing Outliers via Functional Depth

**Why?** Identify days whose diurnal profile is “extreme” (e.g. heat-waves or sensor errors).
**How?** Compute a functional depth measure (e.g. band depth) and plot a functional boxplot.

```{r}
library(fda.usc)

# Compute band depth and functional boxplot
fbplot(
  smoothed_vals,
  factor = 0.9,
  main = "Functional Boxplot: Daily Temperature Curves",
  xlab = "Hour",
  ylab = "Temperature (°C)"
)

fdata_obj <- fdata(t(temp_matrix), argvals = hour_grid)
```

---

## 2. Curve Registration (Alignment)

**Why?** If peak heating times shift (e.g. due to daylight variation), registration will align salient features before FPCA or clustering. 
**How?** Use landmark registration or continuous registration.

```{r}
# # Landmark registration at daily maximum temperature time
# # First find the time of max for each curve
# max.times <- apply(smoothed_vals, 2, function(x) grid[which.max(x)])
# # Create a warping function to align all maxima to, say, hour 14
# target <- rep(14, length(max.times))
# reg_list <- landmarkreg(
#   fdata_obj,
#   # W0 = max.times,
#   # Wt0 = target,
#   # Lfdobj = int2Lfd(2),
#   # lambda = 1e-2
# )
# fd_reg <- reg_list$regfd
# plot(fd_reg, main = "Registered Temperature Curves")
```

---

## 3. Functional ANOVA: Testing Seasonal Differences

**Why?** Statistically test whether mean curves differ by season. 
**How?** Use the `fanova` function from **refund** or **fdANOVA**.

```{r}
library(fdANOVA)

# Prepare grouping factor: season for each column in fd_object
season_vec <- mumbai_data %>%
  distinct(date, season) %>%
  pull(season)

# Perform one-way functional ANOVA
fanova_res <- fanova.onefactor(
  fdata_obj,
  group = season_vec,
  nboot = 200
)
print(fanova_res)
plot(fanova_res) # shows pointwise p-values
```

---

## 4. Functional Linear Model: Relating Curves to Scalar Responses

**Why?** Predict tomorrow’s daily maximum temperature (scalar) from today’s curve (functional predictor). 
**How?** Fit a scalar-on-function regression.

```{r}
library(refund)

# Prepare response: each day’s max temp
y_max <- apply(smoothed_vals, 2, max)

# Scalar-on-function with 5 principal components
pc_scores <- pca.fd(fd_object, nharm = 5)$scores
flm_res <- lm(y_max ~ pc_scores)
summary(flm_res)
```

---

## 5. Functional Time-Series Forecasting (FAR)

**Why?** Forecast the next day’s temperature curve using past curves. 
**How?** Fit a Functional AutoRegressive model of order 1 (FAR(1)).

```{r}
library(ftsa)

# Convert fd_object to a fts object
fts_obj <- fts(grid, smoothed_vals)

# Fit FAR(1)
far1 <- far.ols(fts_obj, p = 1)
# Forecast next 5 days
fc <- forecast(far1, h = 5)
plot(fc, main = "FAR(1) Forecast of Temperature Curves")
```

---

## 6. Clustering & Segmentation of Daily Profiles

**Why?** Discover typical “shapes” of days (e.g. normal vs. heat-wave days). 
**How?** Cluster on FPCA scores or via k-means on principal coefficients.

```{r}
# Use the PC scores from earlier
set.seed(123)
kclust <- kmeans(pc_scores[, 1:3], centers = 3)

# Plot mean curve per cluster
for (k in 1:3) {
  idx <- which(kclust$cluster == k)
  matplot(grid, smoothed_vals[, idx],
    type = "l", lty = 1,
    main = paste("Cluster", k), ylim = range(smoothed_vals)
  )
  lines(grid, rowMeans(smoothed_vals[, idx]), lwd = 3, col = "black")
}
```

---

## 7. Monotonic Smoothing (if applicable)

If you’re modeling a cumulative process (e.g. cumulative heating), enforce monotonicity:

```{r}
# Suppose ycum_matrix is cumulative degree-hours
ycum_matrix <- apply(smoothed_vals, 2, cumsum)
# Create a monotone basis
mon_basis <- create.monomial.basis(c(0, 23), nbasis = 6)
Wfd <- fd(matrix(0, 6, 1), mon_basis)
mon_fdPar <- fdPar(Wfd, 2, lambda = 1e-2)

# Smooth with monotonicity
mon_res <- smooth.monotone(argvals = grid, y = ycum_matrix, WfdPar = mon_fdPar)
dev.off()
plot(mon_res$yhatfd, main = "Monotone Smoothed Curves")
```

### Next Steps

- **Bootstrap Confidence Bands** for mean and FPC curves  
- **Functional Logistic Regression** to classify heat-wave days  
- **Incorporate Covariates** (humidity, wind) in a concurrent functional model  
- **Spatio-Functional Analysis** combining multiple cities via multilevel FDA  
